<!DOCTYPE html>
<html>
  <head>
    <title>PDF Chat Viewer</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='viewer.css') }}"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="viewer-container">
      <!-- PDF Viewer Section -->
      <div class="pdf-section">
        <div class="pdf-header">
          <h2>PDF Viewer</h2>
          <button id="backBtn" onclick="window.location.href='/'">
            ← Upload New PDF
          </button>
        </div>
        <div class="pdf-viewer">
          <iframe id="pdfFrame" src="" width="100%" height="100%"></iframe>
        </div>
      </div>

      <!-- Chat Section -->
      <div class="chat-section">
        <div class="chat-header">
          <div class="header-content">
            <h2>AI Assistant</h2>
            <p>Ask me anything about your PDF!</p>
          </div>
          <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
            <span class="theme-icon">🌙</span>
          </button>
        </div>

        <div class="chat-messages" id="chatMessages">
          <div class="message bot-message">
            <div class="message-content">
              Hello! I've analyzed your PDF. Feel free to ask me any questions
              about its content.
            </div>
          </div>
        </div>

        <div class="chat-input-container">
          <div class="button-row">
            <button id="summarizeBtn" class="summarize-btn">📄 Summarize PDF</button>
            <button id="youtubeBtn" class="youtube-btn">🎥 YouTube Search</button>
          </div>
          
          <div id="youtubeSearch" class="youtube-search" style="display: none;">
            <div class="youtube-input-row">
              <input
                type="text"
                id="youtubeInput"
                placeholder="What do you want to search on YouTube?"
                maxlength="200"
              />
              <button id="searchBtn" class="search-btn">Search</button>
              <button id="cancelBtn" class="cancel-btn">Cancel</button>
            </div>
          </div>
          
          <div class="input-row">
            <input
              type="text"
              id="chatInput"
              placeholder="Ask a question about the PDF..."
              maxlength="500"
            />
            <button id="sendBtn">Send</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Theme Toggle Functionality
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = document.querySelector('.theme-icon');
      
      // Load saved theme or default to dark
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.body.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);
      
      themeToggle.addEventListener('click', () => {
          const currentTheme = document.body.getAttribute('data-theme');
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          
          document.body.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
          updateThemeIcon(newTheme);
      });
      
      function updateThemeIcon(theme) {
          themeIcon.textContent = theme === 'dark' ? '☀️' : '🌙';
      }

      // Load PDF when page loads
      window.addEventListener("load", function () {
        fetch("/get-pdf-info")
          .then((response) => response.json())
          .then((data) => {
            if (data.filename) {
              document.getElementById("pdfFrame").src = "/pdf/" + data.filename;
            } else {
              window.location.href = "/";
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            window.location.href = "/";
          });
      });

      const chatInput = document.getElementById("chatInput");
      const sendBtn = document.getElementById("sendBtn");
      const summarizeBtn = document.getElementById("summarizeBtn");
      const youtubeBtn = document.getElementById("youtubeBtn");
      const youtubeSearch = document.getElementById("youtubeSearch");
      const youtubeInput = document.getElementById("youtubeInput");
      const searchBtn = document.getElementById("searchBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const chatMessages = document.getElementById("chatMessages");

      function addMessage(content, isUser = false) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${
          isUser ? "user-message" : "bot-message"
        }`;

        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";
        contentDiv.innerHTML = content;

        messageDiv.appendChild(contentDiv);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;

        // Add user message
        addMessage(message, true);
        chatInput.value = "";
        sendBtn.disabled = true;
        sendBtn.textContent = "Sending...";

        // Send to backend
        fetch("/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ message: message }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.response) {
              addMessage(data.response);
            } else {
              addMessage("Sorry, I encountered an error. Please try again.");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            addMessage("Sorry, I encountered an error. Please try again.");
          })
          .finally(() => {
            sendBtn.disabled = false;
            sendBtn.textContent = "Send";
          });
      }

      function summarizePDF() {
        // Add "Summarizing..." message
        addMessage("Summarize this PDF", true);
        
        summarizeBtn.disabled = true;
        summarizeBtn.textContent = "Summarizing...";

        // Send summarize request to backend
        fetch("/summarize", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.response) {
              addMessage(data.response);
            } else {
              addMessage("Sorry, I encountered an error while summarizing. Please try again.");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            addMessage("Sorry, I encountered an error while summarizing. Please try again.");
          })
          .finally(() => {
            summarizeBtn.disabled = false;
            summarizeBtn.textContent = "📄 Summarize PDF";
          });
      }

      function showYouTubeSearch() {
        youtubeSearch.style.display = "block";
        youtubeInput.focus();
      }

      function hideYouTubeSearch() {
        youtubeSearch.style.display = "none";
        youtubeInput.value = "";
      }

      function searchYouTube() {
        const searchQuery = youtubeInput.value.trim();
        if (!searchQuery) return;

        // Add user message to show what they're searching for
        addMessage(`Searching YouTube for: ${searchQuery}`, true);
        
        // Send YouTube search request to backend
        fetch("/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ message: `search youtube for: ${searchQuery}` }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.response) {
              addMessage(data.response);
            } else {
              addMessage("YouTube search opened in browser!");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            addMessage("YouTube search opened in browser!");
          });

        hideYouTubeSearch();
      }

      sendBtn.addEventListener("click", sendMessage);
      summarizeBtn.addEventListener("click", summarizePDF);
      youtubeBtn.addEventListener("click", showYouTubeSearch);
      searchBtn.addEventListener("click", searchYouTube);
      cancelBtn.addEventListener("click", hideYouTubeSearch);
      
      chatInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          sendMessage();
        }
      });

      youtubeInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          searchYouTube();
        }
        if (e.key === "Escape") {
          hideYouTubeSearch();
        }
      });
    </script>
  </body>
</html>